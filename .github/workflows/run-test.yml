name: Run Specific Test

on:
  workflow_dispatch:
    inputs:
      test:
        description: 'Test to run (e.g., TextLineTest, PDFAssertionsTest#testAssertPageCount)'
        required: true
        type: string
      java_version:
        description: 'Java version'
        required: false
        default: '11'
        type: choice
        options:
          - '11'
          - '17'
          - '21'
          - '25'
      os:
        description: 'Operating system'
        required: false
        default: 'ubuntu-latest'
        type: choice
        options:
          - 'ubuntu-latest'
          - 'windows-latest'

jobs:
  test:
    runs-on: ${{ inputs.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ inputs.java_version }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ inputs.java_version }}
          distribution: 'temurin'

      - name: Cache Gradle wrapper
        uses: actions/cache@v4
        with:
          path: ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-wrapper-${{ hashFiles('gradle/wrapper/gradle-wrapper.properties') }}
          restore-keys: ${{ runner.os }}-gradle-wrapper-

      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: ~/.gradle/caches
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: ${{ runner.os }}-gradle-

      - name: Set Gradle version based on Java version
        id: gradle-version
        shell: bash
        run: |
          if [ "${{ inputs.java_version }}" = "11" ]; then
            echo "version=8.5" >> $GITHUB_OUTPUT
          elif [ "${{ inputs.java_version }}" = "25" ]; then
            echo "version=9.2.1" >> $GITHUB_OUTPUT
          else
            echo "version=8.10.2" >> $GITHUB_OUTPUT
          fi

      - name: Download and set up Gradle
        shell: bash
        run: |
          GRADLE_VERSION="${{ steps.gradle-version.outputs.version }}"
          cd gradle/wrapper
          echo "distributionUrl=https\://services.gradle.org/distributions/gradle-${GRADLE_VERSION}-bin.zip" > gradle-wrapper.properties

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Make gradlew executable
        if: runner.os != 'Windows'
        run: chmod +x gradlew

      - name: Run test
        if: runner.os != 'Windows'
        run: ./gradlew test --tests "${{ inputs.test }}"
        env:
          PDFDANCER_BASE_URL: https://api-staging.pdfdancer.com
          PDFDANCER_TOKEN: 42

      - name: Run test (Windows)
        if: runner.os == 'Windows'
        shell: cmd
        run: gradlew.bat test --tests "${{ inputs.test }}"
        env:
          PDFDANCER_BASE_URL: https://api-staging.pdfdancer.com
          PDFDANCER_TOKEN: 42

      - name: Upload test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports-${{ github.run_number }}
          path: |
            build/reports/tests/
            build/test-results/
            /tmp/*.pdf
          retention-days: 1
